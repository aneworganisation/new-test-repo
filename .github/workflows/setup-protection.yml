name: Setup Branch Protection & Naming Ruleset

on:
  workflow_dispatch:

jobs:
  protect:
    runs-on: ubuntu-latest
    env:
      OWNER: ${{ github.repository_owner }}
      REPO: ${{ github.event.repository.name }}
      ADMIN_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}

    steps:
      - name: Preflight ‚Äî verify PAT & repo access
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          set -e
          test -n "$GH_TOKEN" || { echo "‚ùå Missing REPO_ADMIN_TOKEN"; exit 1; }
          gh api /user >/dev/null || { echo "‚ùå PAT invalid or expired"; exit 1; }
          gh api "/repos/$OWNER/$REPO" >/dev/null || {
            echo "‚ùå PAT cannot access $OWNER/$REPO ‚Äî check scope, repo access, and SSO auth."
            exit 1
          }
          echo "‚úÖ PAT is valid and can access $OWNER/$REPO"

      - name: Detect default branch
        id: def
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          set -e
          DEF=$(gh api "/repos/$OWNER/$REPO" --jq .default_branch)
          echo "default_branch=$DEF" >> "$GITHUB_OUTPUT"
          echo "‚ÑπÔ∏è Default branch is: $DEF"

      - name: Protect default branch
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          set -e
          DEF="${{ steps.def.outputs.default_branch }}"
          cat <<'JSON' > body.json
          {
            "required_status_checks": {
              "strict": true,
              "contexts": ["build","unit-tests","lint","sast","coverage"]
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "dismiss_stale_reviews": true,
              "require_code_owner_reviews": true,
              "required_approving_review_count": 2
            },
            "restrictions": null,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "required_conversation_resolution": true
          }
          JSON
          gh api --method PUT \
            -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/branches/$DEF/protection" \
            --input body.json

      - name: Enable required signed commits (best effort)
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          DEF="${{ steps.def.outputs.default_branch }}"
          gh api -X POST -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/branches/$DEF/protection/required_signatures" \
            || echo "‚ÑπÔ∏è Signed commits may be restricted ‚Äî skipped."

      - name: Apply branch naming restriction (Ruleset)
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          set -e
          cat <<'JSON' > ruleset.json
          {
            "name": "Branch naming policy",
            "target": "branch",
            "enforcement": "active",
            "conditions": {
              "ref_name": {
                "include": ["*"],
                "exclude": ["main", "release/*"]
              }
            },
            "rules": [
              {
                "type": "branch_name_pattern",
                "parameters": {
                  "name": "Allowed branch names",
                  "negate": false,
                  "operator": "matches",
                  "pattern": "^(feat|fix|hotfix|chore|refactor|docs|test|perf|build|ci|revert)/[a-z0-9._-]+$"
                }
              }
            ],
            "bypass_actors": [],
            "active": true
          }
          JSON

          gh api -X POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/rulesets" \
            --input ruleset.json \
            || echo "‚ö†Ô∏è Ruleset creation may fail if not supported for your plan."

      - name: Protect tags v*
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}
        run: |
          gh api -X POST -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/tags/protection" \
            -f pattern='v*' || echo "‚ÑπÔ∏è Tag protection may already exist."

      - name: Generate local workflow for branch name check (no commit)
        run: |
          set -e
          echo "üìÅ Working directory: $(pwd)"
          mkdir -p .github/workflows
          cat <<'WF' > .github/workflows/branch-name-check.yml
          name: Branch name check
          on:
            create:
            push:
              branches-ignore:
                - main
                - 'release/*'

          jobs:
            enforce:
              runs-on: ubuntu-latest
              steps:
                - name: Validate branch name
                  run: |
                    BRANCH="${GITHUB_REF_NAME}"
                    PATTERN='^(feat|fix|hotfix|chore|refactor|docs|test|perf|build|ci|revert)/[a-z0-9._-]+$'
                    if [[ "$BRANCH" =~ ^(main|release\/.+)$ ]]; then
                      echo "Skipping enforcement for $BRANCH"
                      exit 0
                    fi
                    if [[ "$BRANCH" =~ $PATTERN ]]; then
                      echo "‚úÖ Branch name OK: $BRANCH"
                    else
                      echo "‚ùå Branch name '$BRANCH' does not match required pattern."
                      echo "Examples:"
                      echo "  feat/add-login"
                      echo "  fix/null-pointer"
                      echo "  hotfix/rollback-v123"
                      exit 1
                    fi
          WF
          echo "‚úÖ Created .github/workflows/branch-name-check.yml (not committed)"
